# eBPF 기반 네트워크 지연 조기 탐지 시스템


## 📖 개요 (Overview)

본 프로젝트는 복잡한 클라우드 및 컨테이너 환경(Docker Swarm)에서 시스템 장애가 발생하기 전에 나타나는 미세한 **전조 증상(Precursor)**을 실시간으로 탐지하기 위해 개발되었습니다. 리눅스 커널 기술인 eBPF를 활용하여 시스템 부하를 최소화하며 커널 레벨의 데이터를 실시간으로 수집하고, 이를 XGBoost로 분석하여 장애 전조 증상을 사전에 탐지하는 지능형 모니터링 시스템입니다.

### 핵심 특징
* **초저부하 심층 모니터링 :** eBPF를 활용하여 CPU, 메모리 부하를 최소화하면서, 사용자 영역에서는 볼 수 없는 커널 레벨의 세밀한 메트릭(시스템 콜, 네트워크 스택, TCP 재전송 등)을 실시간으로 확보합니다.
* **예측 기반 선제적 대응 :** 과거 데이터를 기반으로 현재 상태를 판단하는 것을 넘어, XGBoost 모델을 통해 **향후 10초 내의 최대 RTT 값**을 예측합니다. 이를 통해 장애가 발생하기 전에 선제적인 대응이 가능합니다.
* **실제 환경 기반 검증 :** 실제 대학 캠퍼스 네트워크 트래픽 데이터셋(SCIDB)을 분석하여, 정상 트래픽과 폭주 트래픽이 혼재된 **하이브리드 부하 시나리오**를 Docker Swarm 환경에서 재연함으로써 시스템의 실효성을 입증했습니다.
* **통합 웹 대시보드 :** 실시간 예측 RTT, 실제 측정 RTT, 그리고 예측의 근거가 되는 주요 시스템/네트워크 메트릭을 시각화하여 직관적인 모니터링 환경을 제공합니다.
---

## 🏗️ 시스템 아키텍처 (System Architecture)

본 시스템은 크게 **네트워크 패킷 분석, 트래픽 재연, 데이터 분석, ML 학습, 시각화**의 5단계 파이프라인으로 구성됩니다.

1.  **실사례 네트워크 패킷 분석:** Masaryk University에서 공개한 웹 트래픽 데이터셋을 활용하였다. 이 데이터셋은 2021년 7월 30일부터 8월 6일까지 7일간 대학 캠퍼스 네트워크에서 수집된 실제 HTTPS(TLS 1.2) 트래픽으로, 호스팅 환경에서 발생한 네트워크 패킷을 PCAP 형식으로 제공한다. 이 8일치 패킷 파일을 Zeek 네트워크 분석 프레임워크를 통해 분석하여 RPS(Requests Per Second) 패턴, 연결 지속 시간, 요청 간격 등 통계적 특징을 추출하였다.
   <img width="847" height="523" alt="image" src="https://github.com/user-attachments/assets/1446a407-e402-4192-8f1e-55de27806b28" />

위 그래프는 날짜/시간별 트래픽의 변화 정도를 나타낸 그래프이다. 7월 30일과 8월 6일 데이터는 24시간 연속적인 데이터가 확보되지 않아 그래프 시각화에서는 제외하였지만, 학습 데이터로는 부분적으로 활용하여 최종적으로 8일치의 패턴을 모델 학습에 사용하였다. 각 날짜의 데이터마다 http, ssl, conn 등의 다양한 로그 파일이 생성되었으며, 로그파일들에서 통계적 특징을 추출하기 위한 자동스크립트를 작성하여 이용하였다. (로그 파일은 크기 제한 때문에 업로드하지 않았다.)
결과적으로 각 날짜별 통계결과파일이 txt 형태로 생성되었으며, 그 자료들은 다음 단계에서 lua 파일 작성에 이용되었다.


2.  **장애상황 재연 및 데이터 수집:**
   <img width="1431" height="803" alt="image" src="https://github.com/user-attachments/assets/c2246878-54c7-4805-b0aa-7c4a346bdc79" />
   실제 네트워크 환경과 유사한 부하 분산 처리를 위해 Docker Swarm Orchestration 기반의 분산 트래픽 재연 환경을 구축한다. 총 10개의 Nginx 컨테이너를 구성하여 타겟 시스템에 대한 대규모 동시 접속 및 고부하 상황을 모사할 수 있도록 설계한다.

트래픽 생성 엔진으로는 `wrk HTTP 벤치마킹` 도구를 활용하였으며, 단순한 요청 반복을 넘어 8일 간의 실제 데이터셋 분석 결과를 정교하게 반영하기 위해 Custom Lua Script를 개발하였다.

 이 스크립트를 통해 각 날짜별 핵심 특징인 사용자 에이전트 분포, 도메인별 가중치, 비정상 연결 종료(RSTR) 패턴 등을 실제와 동일하게 구현한다. 나아가, 장애 예측 학습에 유의미한 데이터를 확보하기 위해 실제 시간대별 트래픽 패턴을 따르는 정상구간과, 시스템 한계치까지 연결 수를 임의로 증폭시켜 CPU 및 네트워크 I/O 병목을 유도하여 폭주구간으로 시나리오를 구성해 네트워크 트래픽을 발생시킨다.


3.  **eBPF 기반 시스템 메트릭 파싱 모듈 제작:**
시스템 부하 상황을 정밀하게 기록하기 위해 eBPF 및 리눅스 커널 도구를 활용한 데이터 수집 및 전처리 파이프라인을 구축하였습니다.
  - 커널 레벨 데이터 수집 : bpftrace를 활용하여 TCP 재전송, 패킷 처리량, 메모리 할당 이벤트 등 OS 커
    널 레벨의 지표를 수집하여, 일반적인 애플리케이션 레벨 모니터링보다 정밀한 데이터를 확보하였습니다.
   - 시스템 전반의 리소스 관측: 네트워크뿐만 아니라 시스템 전체의 병목을 파악하기 위해 다양한 메트릭을
     수집합니다.

서로 다른 주기로 수집되는 로그 데이터들의 시간축을 동기화하기 위해 Python 기반의 전처리 모듈을 개발하였습니다. 이 모듈을 통해 수집된 로그를 타임스탬프를 기준으로 데이터를 병합하고 머신러닝 모델 학습에 적합한 CSV 포맷으로 변환합니다.
  
4.  **ML 학습:** XGBoost, LSTM, Transformer 모델을 사용하여 학습 진행하였음. 학습 전 전체 데이터에 대해 과거 4초간 데이터의 평균으로 전처리하여 분산도를 줄여 전체적인 추세를 학습하는데 집중할 수 있도록 하였음. 예측하는 값으로 슬라이딩 윈도우 기법을 적용하여 향후 10초간 rtt값 중 최대치를 예측하도록 하여 **위험 감지 시스템** 이라는 목적에 맞도록 설계하고 데이터를 전처리하였음. 각 3개의 모델에 대해 학습을 진행하였고, XGBoost 모델은 GridSearchCV 기법을 통해 최적의 하이퍼파라미터 탐색을 진행, 최적의 값을 도출하였음. 
  
5.  **모듈통합 및 UI 제작:** 앞서 제작한 시스템 데이터 파싱 모듈, 학습된 ML 모델등을 사용하여 실제 시스템을 실시간으로 모니터링 하며 10초후 RTT 값을 예측, 시각화 하는 web 기반 UI 를 제공. 그래프 형태로 실제값과 예측값을 함께 볼수 있으며 Feature 로 사용된 상세메트릭들 또한 시각화 기능을 제공. UI 디렉토리에 최종 프로그램이 포함되어 있으며 실행방법은 UI 폴더 내의 README 파일과 requirments 를 참조.

---

## 💻 웹 UI
### 1. 메인 대시보드 
실시간 시스템 상태(정상/위험), 네트워크 트래픽 추이, 그리고 가장 중요한 **실측 RTT와 예측 RTT 그래프**를 제공합니다. 예측 RTT가 임계치를 초과할 경우 즉시 경고를 표시합니다.
<img width="809" height="401" alt="image" src="https://github.com/user-attachments/assets/cfc7aa0c-2837-4832-8f8f-cbf4566cfeeb" />
### 2. 상세 분석 페이지
RTT 예측에 영향을 미친 주요 Feature들의 실시간 값을 보여줍니다. 어떤 메트릭(예: TCP 재전송 증가, CPU 부하 등)이 RTT 증가의 원인인지 파악할 수 있습니다.
<img width="834" height="401" alt="image" src="https://github.com/user-attachments/assets/eafa9348-a26b-4764-a685-95ada9000ce2" />
### 3. 히스토리 조회
과거 RTT 데이터 이력과 발생했던 알림 로그를 조회할 수 있습니다.
<img width="826" height="391" alt="image" src="https://github.com/user-attachments/assets/9747e368-1595-4afb-8dd7-3277fa4e2882" />


## 💻 설치 및 실행 (Installation & Usage)

### 시스템 요구사항 (Prerequisites)
* **OS:** Linux (Kernel 5.4 이상 권장, eBPF/BCC 지원 필수)
* **Container:** Docker Engine & Docker Swarm Mode 활성화
* **Language:** Python 3.8 이상 feature
* **Tools:** `bpftrace`, `wrk`, Zeek

### 실행 요약 (Quick Start Summary)

1.  **환경 설정:** Docker Swarm 클러스터 구성 및 타겟 서비스(Nginx) 배포.
2.  **데이터 수집기 실행:** eBPF 스크립트 및 시스템 메트릭 수집기 실행 (root 권한 필요).
3.  **트래픽 재연기 실행:** `wrk` 및 Lua 스크립트를 통한 하이브리드 부하 시나리오 실행.
4.  **웹 서버 실행:** `UI` 디렉토리로 이동하여 필요한 패키지 설치 후 웹 서버 실행.
5.  **접속:** 브라우저를 통해 웹 대시보드 접속 및 모니터링 시작.


## Data / Dataset (데이터셋 출처)

본 프로젝트는 eBPF 모델 학습 및 분석을 위해 공개된 실제 네트워크 트래픽 데이터셋을 사용했습니다.

* **데이터셋 명칭:** Encrypted Web Traffic Dataset: Event Logs and Packet Traces
* **제공 기관:** 체코 마사리크 대학교 CSIRT-MU (Masaryk University, Czech Republic)
* **사용 범위:** 8일치 트래픽 데이터 (pcap 파일)
* **학술적 배경:** Data in Brief 논문
* **원문 링크:** (https://www.scidb.cn/en/detail?dataSetId=ec72229d46624e4e8b8528dd0485f5b4#p2)

**[필수]** 해당 데이터셋을 사용하실 경우, 원저작자가 요구하는 라이선스 조건을 준수해야 합니다.

